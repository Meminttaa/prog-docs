import psycopg2
import json

DB = {
    "host": "10.179.101.80",
    "port": 5432,
    "dbname": "postgres",
    "user": "postgres",
    "password": "12345678"   # –∑–∞–º–µ–Ω–∏ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏
}


def make_initials(fio):
    """
    –§–æ—Ä–º–∞—Ç: –ö.–ê. –§–∞–º–∏–ª–∏—è
    –û–∂–∏–¥–∞–µ—Ç—Å—è –§–∞–º–∏–ª–∏—è –ò–º—è –û—Ç—á–µ—Å—Ç–≤–æ
    """
    if not fio:
        return ""

    parts = fio.split()

    if len(parts) >= 3:
        last_name = parts[0]
        first_name = parts[1]
        middle_name = parts[2]
        return f"{first_name[0]}.{middle_name[0]}. {last_name}"

    if len(parts) == 2:
        last_name = parts[0]
        first_name = parts[1]
        return f"{first_name[0]}. {last_name}"

    return fio


conn = psycopg2.connect(**DB)
cur = conn.cursor()

query = """
SELECT
    "–§–ò–û_–æ–±—É—á–∞—é—â–µ–≥–æ—Å—è",
    "–î–∞—Ç–∞_—Ä–æ–∂–¥–µ–Ω–∏—è",

    "–∫–æ–¥_—Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–∏",
    "–Ω–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ_—Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–∏",

    "–Ω–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ_–º–æ–¥—É–ª—è",
    "–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ_—á–∞—Å–æ–≤_–ü–ü",

    "–¥–µ–Ω—å_–Ω–∞—á–∞–ª–∞_–ü–ü",
    "–º–µ—Å—è—Ü_–Ω–∞—á–∞–ª–∞_–ü–ü",
    "–≥–æ–¥_–Ω–∞—á–∞–ª–∞_–ü–ü",

    "–¥–µ–Ω—å_–∫–æ–Ω—Ü–∞_–ü–ü",
    "–º–µ—Å—è—Ü_–∫–æ–Ω—Ü–∞_–ü–ü",
    "–≥–æ–¥_–∫–æ–Ω—Ü–∞_–ü–ü",

    "–Ω–∞–∑–≤–∞–Ω–∏–µ_–æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏",
    "–∞–¥—Ä–µ—Å_–æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏",
    "–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ_–ø–æ–º–µ—â–µ–Ω–∏–π",

    "–§–ò–û_–ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—è",
    "—Ç–µ–ª_–ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç—Ç–µ–ª—è",

    "–§–ò–û_–æ—Ç–≤_–æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏",
    "–¥–æ–ª–∂–Ω–æ—Å—Ç—å_–æ—Ç–≤_–æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏",
    "—Ç–µ–ª_–æ—Ç–≤_–æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏",

    "–§–ò–û_–æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ",
    "–¥–æ–ª–∂–Ω–æ—Å—Ç—å_–æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ",
    "—Ç–µ–ª_–æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ"
FROM "—Å–≤–æ–¥–∫–∞_–ø–æ_–ø—Ä–∞–∫—Ç–∏–∫–µ"
ORDER BY "–Ω–∞–∑–≤–∞–Ω–∏–µ_–æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏", "–§–ò–û_–æ–±—É—á–∞—é—â–µ–≥–æ—Å—è";
"""

cur.execute(query)

columns = [desc[0] for desc in cur.description]
students = []

for row in cur.fetchall():
    student = {}

    for col, val in zip(columns, row):
        student[col] = "" if val is None else str(val)

    # –∏–Ω–∏—Ü–∏–∞–ª—ã –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –æ—Ç –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏ (–ö.–ê. –ì—É—Ä–º–∞–Ω)
    student["–∏–Ω–∏—Ü–∏–∞–ª—ã_–æ—Ç–≤_–æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏"] = make_initials(
        student.get("–§–ò–û_–æ—Ç–≤_–æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏")
    )

    # üî• –∞–≤—Ç–æ–ø–æ–¥–º–µ–Ω–∞: –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π = –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π –æ—Ç –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏
    if not student.get("–§–ò–û_–æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ"):
        student["–§–ò–û_–æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ"] = student.get("–§–ò–û_–æ—Ç–≤_–æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏", "")

    if not student.get("–¥–æ–ª–∂–Ω–æ—Å—Ç—å_–æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ"):
        student["–¥–æ–ª–∂–Ω–æ—Å—Ç—å_–æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ"] = student.get("–¥–æ–ª–∂–Ω–æ—Å—Ç—å_–æ—Ç–≤_–æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏", "")

    if not student.get("—Ç–µ–ª_–æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ"):
        student["—Ç–µ–ª_–æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ"] = student.get("—Ç–µ–ª_–æ—Ç–≤_–æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏", "")

    students.append(student)

cur.close()
conn.close()

with open("all_students_data.json", "w", encoding="utf-8") as f:
    json.dump(
        {
            "students": students,
            "total_students": len(students)
        },
        f,
        ensure_ascii=False,
        indent=2
    )

print(f"‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ —Å—Ç—É–¥–µ–Ω—Ç–æ–≤ –∏–∑ –ë–î: {len(students)}")

